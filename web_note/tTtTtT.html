<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    <!-- Title -->
    <title>測試區</title>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="../css/bootstrap_5.3.3_css/bootstrap.min.css"/>
    <link rel="stylesheet" href="../css/bootstrap_icons-main/font/bootstrap-icons.css"/>
    <link rel="stylesheet" href="../css/font_awesome_v6.5.2_all.css" type="text/css" />
    <link rel="stylesheet" href="../css/animate_v4.1.1_min.css">
    <link rel="stylesheet" href="../css/main.css"/>

    <!-- jQuery -->
    <script src="../js/jquery_v3.7.1_min.js"></script>
    <!-- Bootstrap Bundle JS -->
    <script src="../js/bootstrap_5.3.3_js/bootstrap.bundle.min.js"></script>
    <script src="../js/d3_v7.9.0_min.js"></script>
    <script src="../js/wow_v1.1.3_min.js"></script>
    <script src="../js/script.js"></script>
    <style>
      body {
        padding: 30px;
      }
    </style>
  </head>
  <body>
    <h2>歡迎來到第二測試場</h2>
    <button class="btn btn-outline-danger" onclick="window.close();">關閉目前視窗</button>
    <hr>
    <div id="d3jsEnergyGainPieChart" class="mt-1"></div>
  <div class="d-flex justify-content-center">
    <button type="button" id="d3jsEnergyGainPieChart2023MayBtn" class="btn btn-warning mx-1">2023/05</button>
    <button type="button" id="d3jsEnergyGainPieChart2023JuneBtn" class="btn btn-warning mx-1">2023/06</button>
    <button type="button" id="d3jsEnergyGainPieChart2023JulyBtn" class="btn btn-warning mx-1">2023/07</button>
  </div>
  <script>
    const d3jsEnergyGainChart = async() => {
      const width = 600;
      const height = 400;
      const margin = 40;

      // 切換月份的按鈕
      const May2023Btn = d3.select("#d3jsEnergyGainPieChart2023MayBtn")
                           .on("click", (e, d) => {
                             May2023Btn.style("background-color", "#e09500")
                             June2023Btn.style("background-color", "#ffc107")
                             July2023Btn.style("background-color", "#ffc107")
                             upDatePieData(data202305)
                           });
      const June2023Btn = d3.select("#d3jsEnergyGainPieChart2023JuneBtn")
                            .on("click", (e, d) => {
                              May2023Btn.style("background-color", "#ffc107")
                              June2023Btn.style("background-color", "#e09500")
                              July2023Btn.style("background-color", "#ffc107")
                              upDatePieData(data202306)
                            });
      const July2023Btn = d3.select("#d3jsEnergyGainPieChart2023JulyBtn")
                            .on("click", (e, d) => {
                              May2023Btn.style("background-color", "#ffc107")
                              June2023Btn.style("background-color", "#ffc107")
                              July2023Btn.style("background-color", "#e09500")
                              upDatePieData(data202307)
                            });

      // 獲取數據
      let data202305 = await d3.csv("../data/energyGain/202305.csv");
      data202305 = data202305.filter((d, i) => i >= 1 && i <= 4);
      let data202306 = await d3.csv("../data/energyGain/202306.csv");
      data202306 = data202306.filter((d, i) => i >= 1 && i <= 4);
      let data202307 = await d3.csv("../data/energyGain/202307.csv");
      data202307 = data202307.filter((d, i) => i >= 1 && i <= 4);
      
      // 建立svg
      const svg = d3.select("#d3jsEnergyGainPieChart")
                    .append("svg")
                    .attr("width", width)
                    .attr("height", height);

      // 建立圓餅圖的群組元素'g'，用來容納圓餅圖的切片
      svg.append("g")
         .attr("id", "d3jsEnergyGainPieChartSlices")
         .attr("transform", `translate(${width / 2}, ${height / 2})`);

      // 設定顏色比例尺，從'd3.schemeSet2'配色方案中選取顏色
      const color = d3.scaleOrdinal()
                      .domain(['breakfast', 'lunch', 'dinner', 'snack'])
                      .range(d3.schemeTableau10);

      // 設定圓餅圖的半徑
      const radius = Math.min(width, height) / 2 - margin;

      // 設定更新資料的方法，把要繪圖的函式放進去，以讓它們能夠重新繪圖
      const upDatePieData = (data) => {

        // 設定圓餅圖的生成器，指定根據'data'屬性來生成圖表
        const pieChartGenerator = d3.pie().value((d) => d.total).sort((a, b) => d3.ascending(a.key, b.key));

        // 設定每個圓餅圖切片的弧度生成器，定義內半徑和外半徑
        const arc = d3.arc()
                      .innerRadius(0)  // 設定內半徑為0（實心圓）
                      .outerRadius(radius)  // 設定外半徑為計算出的半徑值
                      .padAngle(0);

        // 設定外弧，用於放置標籤或其他用途
        const outerArc = d3.arc()
                           .outerRadius(radius)
                           .innerRadius(radius - 10);

        // 使用圓餅圖生成器將資料轉換為可以繪製的形式
        const pieChartData = pieChartGenerator(data);

        // 在群組元素中綁定資料並生成'path'元素，代表圓餅圖的每一塊
        const energyGainChart = svg.select("#d3jsEnergyGainPieChartSlices")
                                   .selectAll("path")
                                   .data(pieChartData)
                                   .join("path")
                                   .attr("class", "d3jsEnergyGainPieChartArc")  // 設定弧形們的class
                                   .transition()
                                   .duration(800)
                                   .attr("d", arc)  // 根據生成的弧形路徑繪製圓餅圖
                                   .attr("fill", (d) => color(d.data.date))  // 根據資料設定填充顏色（此處壓'date'乃僅因剛好資料中餐別的行首是'date'）
                                   .attr("stroke", "#f2f2f2")  // 設定弧形的邊框顏色為類白色
                                   .attr("stroke-width", "3px")  // 設定邊框寬度為3像素
                                   .style("opacity", 1);  // 設定每個切片的透明度為1（不透明）

        // 加上每個區塊的數字標示，計算百分比並設定標籤文字
        const dataTotal = d3.sum(data, (d) => d.total);  // 計算總支出金額
        data.forEach((i) => {  // 透過一個forEach迴圈，計算每項支出佔總額的百分比
          i.percentage = Math.round((i.total / dataTotal) * 100);  // 在原始data新增一個名為'percentage'的新屬性，儲存百分比
        });

        // 定義餐別名，製作文字標籤用
        const mealType = d3.scaleOrdinal()
                           .domain(['breakfast', 'lunch', 'dinner', 'snack'])
                           .range(['早餐', '午餐', '晚餐', '點心']);

        // 綁定標籤資料，生成'text'元素並設定位置、文字內容、樣式
        const labels = d3.select("#d3jsEnergyGainPieChartSlices")
                         .selectAll("text")
                         .data(pieChartData)  // 需使用d3.pie()處理後的資料，因為原始資料沒有角度資訊
                         .join("text")
                         .attr("class", "d3jsEnergyGainPieChartLabels")
                         .transition()
                         .duration(800)
                         .attr("transform", (d) => `translate(${outerArc.centroid(d)})`)
                         .text((d) => mealType(d.data.date) + " " + d.data.percentage + "%")  // 'd.data'是d3.pie()處理後的資料裡所包含的原始資料部分
                         .style("text-anchor", "middle")
                         .style("font-size", 16)
                         .style("fill", "black");
      };
      upDatePieData(data202305);

      // 設定滑鼠互動事件，當滑鼠移到圓餅圖的切片上時，切片會放大並產生陰影
      d3.selectAll(".d3jsEnergyGainPieChartArc")
        .style("cursor", "pointer")
        .on("mouseover", (e, d) => {  // 當滑鼠移到切片上時觸發
          d3.select(e.target)
            .transition()
            .duration(500)
            .style("transform", "scale(1.1)");  // 將切片放大至1.1倍
        
          d3.selectAll(".d3jsEnergyGainPieChartLabels")
            .filter((labelData) => labelData.index === d.index)  // 選取對應的標籤
            .transition()
            .duration(500)
            .style("font-size", "24px");

          // 加Tooltip
          const pt = d3.pointer(e, e.target);
          d3.select("#d3jsEnergyGainPieChart")
            .style("position", "relative")
            .append("div")
            .style("position", "absolute")
            .attr("class", "d3jsEnergyGainPieChartToolpix")
            .style("left", `${pt[0] + 320}px`)  // '320'為偏移修正量
            .style("top", `${pt[1] + 140}px`)  // '140'為偏移修正量
            .style("background-color", "#f2f2f2")
            .style("color", "#121212")
            .style("border", "2px solid #121212")
            .style("border-radius", "5px")
            .style("padding", "10px")
            .html(`共 ${d.data.total} 大卡`)
        })
        .on("mousemove", (e, d) => {
          d3.select(e.target)
            .style("filter", "drop-shadow(2px 4px 6px #000000)");  // 加上陰影效果

          // 移動Tooltip
          const pt = d3.pointer(e, e.target);
          d3.select(".d3jsEnergyGainPieChartToolpix")
            .style("left", `${pt[0] + 320}px`)  // '320'為偏移修正量
            .style("top", `${pt[1] + 140}px`);  // '140'為偏移修正量
        })
        .on("mouseleave", (e, d) => {  // 當滑鼠離開切片時觸發
          d3.select(e.target)
            .transition()
            .duration(500)
            .style("filter", "drop-shadow(0 0 0 black)")  // 移除陰影效果
            .style("transform", "scale(1)");  // 將切片還原到原始大小
        
          d3.selectAll(".d3jsEnergyGainPieChartLabels")
            .filter((labelData) => labelData.index === d.index)  // 選取對應的標籤
            .transition()
            .duration(500)
            .style("font-size", "16px");

          // 移出圓餅圖後刪除tooltip
          d3.select(".d3jsEnergyGainPieChartToolpix").remove();
        });
    };
    d3jsEnergyGainChart();
  </script>
  </body>
</html>