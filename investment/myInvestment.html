<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    <!-- Title -->
    <title>阿蛤ㄉ窩 - 投資總覽</title>
    <link rel="icon" href="favicon/favicon-v1.0.png" type="images/png">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="../css/bootstrap_5.3.3_css/bootstrap.min.css"/>
    <link rel="stylesheet" href="../css/bootstrap_icons-main/font/bootstrap-icons.css"/>
    <link rel="stylesheet" href="../css/font_awesome_v6.5.2_all.css" type="text/css" />
    <link rel="stylesheet" href="../css/animate_v4.1.1_min.css">
    <link rel="stylesheet" href="../css/vs2015_min.css">
    <!-- <link rel="stylesheet" href="../css/main.css"/> -->

    <!-- jQuery -->
    <script src="../js/jquery_v3.7.1_min.js"></script>
    <!-- Bootstrap Bundle JS -->
    <script src="../js/bootstrap_5.3.3_js/bootstrap.bundle.min.js"></script>
    <script src="../js/d3_v7.9.0_min.js"></script>
    <script src="../js/wow_v1.1.3_min.js"></script>
    <script src="../js/highlight_min.js"></script>
    <script src="../js/script.js"></script>

    <!-- 啟用 Highlight.js -->
    <script>hljs.highlightAll();</script>  

    <!-- Tooltip引用統計學頁面，需以latex渲染數學公式 -->
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  
    <style>
      body {
        background-color: #060606;
      }
      .myInvestmentUnit {
        background-color: #121212;
        border: 0.2px solid #242424;
        border-radius: 8px;
      }

      /* footer（移植自main.css） */
      footer h5 {
        color: #ffffff;
      }

      footer p {
        font-size: 14px;
        color: #eeeeee;
      }

      footer a {
        font-size: 24px;
        color: #eeeeee;
      }

      footer a:hover {
        transform: translateY(-1.5px);
        transition: transform 0.2s ease-in-out;
      }
    </style>
  </head>

  <body>
    <main>
      <div class="container-fluid">
        <div class="row">
          <section class="myInvestmentUnit">
            <div id="assets"></div>
            <script>
              const assets = async () => {
                const width = parseInt(d3.select("#assets").style("width"));
                const height = width>900 ? 600 : width*0.7 ;
                const margin = 70;
                // 因需隨視窗大小更改而即時更改圖型，故'svg'改為以下寫法
                let svg = d3.select("#assets").select("svg");
                if (svg.empty()) {
                  svg = d3.select("#assets")
                          .append("svg")
                          .attr("width", width)
                          .attr("height", height);
                } else {
                  svg.attr("width", width)
                     .attr("height", height);
                };
                svg.selectAll("*").remove();  // 清空之前的圖表元素，以重新繪製
                
                // title
                svg.append("text")
                   .attr("x", width>800 ? width/4 : width/3)
                   .attr("y", height / 2)
                   .attr("text-anchor", "middle")
                   .attr("font-size", width>800 ? 20 : 18)
                   .attr("font-family", "serif")
                   .attr("font-style", "italic")
                   .style("fill", "#f2f2f2")
                   .text("- 每日錢錢統計 -");

                // 匯入及解析資料
                const data = await d3.csv("../data/investment/assets.csv");
                const parseData = data.map((d) => ({
                  date: d3.timeParse("%Y/%m/%d")(d["日期"]),
                  taiwanCooperativeBank: +d["合作金庫銀行"].replace(/,/g, "") || 0,
                  chunghwaPost: +d["郵局"].replace(/,/g, "") || 0,
                  cathayUnitedBank: +d["國泰世華銀行"].replace(/,/g, "") || 0,
                  taishinInternationalBank: +d["台新銀行"].replace(/,/g, "") || 0,
                  stock: +d["股票當日市值"].replace(/,/g, "") || 0,
                  sum: (+d["合作金庫銀行"].replace(/,/g, "") || 0) +
                       (+d["郵局"].replace(/,/g, "") || 0) +
                       (+d["國泰世華銀行"].replace(/,/g, "") || 0) +
                       (+d["台新銀行"].replace(/,/g, "") || 0) +
                       (+d["股票當日市值"].replace(/,/g, "") || 0),
                  depositRatio: (
                                  (+d["合作金庫銀行"].replace(/,/g, "") || 0) +
                                  (+d["郵局"].replace(/,/g, "") || 0) +
                                  (+d["國泰世華銀行"].replace(/,/g, "") || 0) +
                                  (+d["台新銀行"].replace(/,/g, "") || 0)
                                ) / (
                                  (+d["合作金庫銀行"].replace(/,/g, "") || 0) +
                                  (+d["郵局"].replace(/,/g, "") || 0) +
                                  (+d["國泰世華銀行"].replace(/,/g, "") || 0) +
                                  (+d["台新銀行"].replace(/,/g, "") || 0) +
                                  (+d["股票當日市值"].replace(/,/g, "") || 0)
                                ) * 100
                }));

                const color = d3.scaleOrdinal()
                                .domain(["taiwanCooperativeBank", "chunghwaPost", "cathayUnitedBank", "taishinInternationalBank", "stock", "sum"])
                                .range(["#f5ba1a", "#e37933", "#6ea647", "#a5a5a5", "#406cb4", "#d0d2d2"]);

                // X軸
                const xScale = d3.scaleTime()
                                 .domain([
                                   d3.min(parseData, d => d["date"]),
                                   d3.timeMonth.offset(d3.max(parseData, d => d["date"]), 3)  // 最大日期往後加2年
                                  ])
                                 .range([margin, width - margin]);
                const xAxisGenerator = d3.axisBottom(xScale)
                                         .tickFormat(d => d3.timeFormat("%Y %b %d")(d))
                                         .ticks(width>500 ? 10 : 5)
                                         .tickSizeOuter(0);
                const xAxis = svg.append("g")
                                 .attr("transform", `translate(0, ${height - margin})`)
                                 .call(xAxisGenerator);
                xAxis.selectAll(".tick text")
                     .attr("transform", "translate(-25, 25) rotate(-45)")
                     .style("fill", "#b2b2b2");  // 選轉文字、改變文字顏色
                xAxis.selectAll(".tick line")
                     .style("stroke", "#b2b2b2");  // 改變刻度線顏色
                xAxis.selectAll(".domain")
                     .style("stroke", "#b2b2b2");  // 改變X軸主軸線顏色

                // Y軸
                const yScale = d3.scaleLinear()
                                 .domain([0, d3.max(parseData, d => d["sum"])])
                                 .range([height - margin, margin])
                                 .nice();
                const yAxisGenerator = d3.axisLeft(yScale)
                                         .tickFormat(d => d3.format(",")(d) + " 元");
                const yAxis = svg.append("g")
                                 .attr("transform", `translate(${margin}, 0)`)
                                 .call(yAxisGenerator);
                yAxis.selectAll(".tick text")
                     .style("fill", "#b2b2b2");  // 改變文字顏色
                yAxis.selectAll(".tick line")
                     .style("stroke", "#b2b2b2");  // 改變刻度線顏色
                yAxis.selectAll(".domain")
                     .style("stroke", "#b2b2b2");  // 改變Y軸主軸線顏色

                // 建立tooltip
                const tooltip = d3.select("#assets")
                                  .style("position", "relative")
                                  .append("div")
                                  .attr("class", "assetsNameTag")
                                  .style("position", "absolute")
                                  .style("background-color", "#f2f2f2")
                                  .style("color", "#121212")
                                  .style("border-radius", "5px")
                                  .style("padding", "10px")
                                  .style("font-size", "14px")
                                  .style("white-space", "nowrap")
                                  .style("display", "none");

                // 開始建立折線圖
                const bankKeys = ["taiwanCooperativeBank", "chunghwaPost", "cathayUnitedBank", "taishinInternationalBank", "stock", "sum"];
                const lineGenerator = d3.line()
                                        .x((d) => xScale(d.date))
                                        .y((d) => yScale(d.yValue));
                const lines = svg.append("g");
                const focusDots = svg.append("g");

                bankKeys.forEach((key) => {
                  // 折線
                  lines.append("path")
                       .datum(parseData.map((d) => ({
                         date: d.date,
                         yValue: d[key]
                       })))
                       .attr("class", "assetsLine")
                       .attr("d", lineGenerator)
                       .attr("fill", "none")
                       .attr("stroke", color(key))
                       .attr("stroke-width", 1.5);

                  // 小圓點
                  focusDots.selectAll(`#${key}FocusDot`)
                           .data(parseData, d => d.date)  // 用日期作為唯一識別
                           .join(
                             enter => enter.append("circle")
                                           .attr("id", d => `${key}FocusDot_${d3.timeFormat("%Y-%b-%d")(d.date)}`)
                                           .attr("cx", d => xScale(d.date))
                                           .attr("cy", d => yScale(d[key]))
                                           .attr("r", 3)
                                           .style("fill", color(key))
                                           .style("stroke", "f2f2f2")
                                           .style("stroke-width", 0.3)
                                           .style("opacity", 0),
                             update => update.attr("cx", d => xScale(d.date))
                                             .attr("cy", d => yScale(d[key])),
                             exit => exit.remove()
                           );
                });

                // 建立一個覆蓋SVG的方形
                svg.append("rect")
                   .style("fill", "transparent")
                   .style("pointer-events", "all")
                   .style("cursor", "pointer")
                   .attr("width", width - margin)
                   .attr("height", height - margin)
                   .on("mouseover", mouseover)
                   .on("mousemove", mousemove)
                   .on("mouseout", mouseout);

                // 使用d3.bisector()找到根據資料的date對應的資料點
                const bisect = d3.bisector((d) => d.date).left;

                function mouseover() {
                  // focusDots.selectAll("circle").style("opacity", 1);
                  tooltip.style("display", "block");
                };

                function mousemove(e) {
                  const [mouseX, mouseY] = d3.pointer(e, this);  // 用解構賦值語法取得滑鼠的x位置
                  const xDate = xScale.invert(mouseX);  // 根據滑鼠的x位置取得在座標上的時刻（日期）
                  const i = bisect(parseData, xDate);  // 用bisector找到離滑鼠最近的資料點index
                  const closestDot = parseData[i];  // 取得最近的資料點
                  const formattedClosestDotDate = d3.timeFormat("%Y-%b-%d")(closestDot.date);

                  // 先隱藏所有圓點和所有tooltip，及消除dashedY
                  focusDots.selectAll("circle").style("opacity", 0);
                  tooltip.style("display", "none");
                  svg.selectAll(".assetsDashedY").remove();
                  svg.selectAll(".assetsDashedYText").remove();

                  // 再顯示對應位置的圓點
                  bankKeys.forEach((key) => {
                    const focusDot = svg.select(`#${key}FocusDot_${formattedClosestDotDate}`);
                    if (!focusDot.empty()) {
                      focusDot.style("opacity", 1);
                    } else {
                      focusDot.style("opacity", 0);
                    };

                    tooltip.style("display", "block")
                           .style("left", mouseX + 20 + "px")
                           .style("top", mouseY - 200 + "px")
                           .html(`日期：${d3.timeFormat("%Y.%m.%d")(closestDot.date)}<br>` +
                                 `合作金庫銀行：${d3.format(",")(closestDot.taiwanCooperativeBank)}<br>` +
                                 `郵局：${d3.format(",")(closestDot.chunghwaPost)}<br>` +
                                 `國泰世華銀行：${d3.format(",")(closestDot.cathayUnitedBank)}<br>` +
                                 `台新銀行：${d3.format(",")(closestDot.taishinInternationalBank)}<br>` +
                                 `股票當日市值：${d3.format(",")(closestDot.stock)}<br>` +
                                 `總和：${d3.format(",")(closestDot.stock)}<br>` +
                                 `活存佔比(%)：${d3.format(".2f")(closestDot.depositRatio)} %`)
                  });

                  // 建立Y-dashed線
                  svg.append("line")
                     .attr("class", "assetsDashedY")
                     .attr("x1", margin)
                     .attr("y1", yScale(closestDot.sum))
                     .attr("x2", xScale(closestDot.date))
                     .attr("y2", yScale(closestDot.sum))
                     .style("stroke", "#d0d2d2")
                     .style("stroke-dasharray", "4");

                  // Y-dashed線上的文字
                  svg.append("text")
                     .attr("class", "assetsDashedYText")
                     .attr("x", margin + 5)
                     .attr("y", yScale(closestDot.sum) - 3)
                     .attr("fill", "#d0d2d2")
                     .style("font-size", 12)
                     .style("text-anchor", "start")
                     .text(d3.format(",")(closestDot.sum));
                };
                
                function mouseout() {
                  focusDots.selectAll("circle").style("opacity", 0);
                  tooltip.style("display", "none");
                  svg.selectAll(".assetsDashedY").remove();
                  svg.selectAll(".assetsDashedYText").remove();
                };
              };
              assets();
              // 監聽視窗大小變動（待處理）
              window.addEventListener("resize", assets);
            </script>
          </section>
          <section class="myInvestmentUnit col-xxl-3 col-lg-4 col-sm-6 g-2">Div 3</section>
          <section class="myInvestmentUnit col-xxl-3 col-lg-4 col-sm-6 g-2">Div 4</section>
          <section class="myInvestmentUnit col-xxl-3 col-lg-4 col-sm-6 g-2">Div 5</section>
          <section class="myInvestmentUnit col-xxl-3 col-lg-4 col-sm-6 g-2">Div 6</section>
          <section class="myInvestmentUnit col-xxl-3 col-lg-4 col-sm-6 g-2">Div 7</section>
          <section class="myInvestmentUnit col-xxl-3 col-lg-4 col-sm-6 g-2">Div 8</section>
          <section class="myInvestmentUnit col-xxl-3 col-lg-4 col-sm-6 g-2">Div 9</section>
          <section class="myInvestmentUnit col-xxl-3 col-lg-4 col-sm-6 g-2">Div 10</section>
          <section class="myInvestmentUnit col-xxl-3 col-lg-4 col-sm-6 g-2">Div 11</section>
          <section class="myInvestmentUnit col-xxl-3 col-lg-4 col-sm-6 g-2">Div 12</section>
          
        </div>
      </div>
    </main>
    <footer class="container-fluid" style="background-color: #3c3c3c; padding: 25px; padding-left: 35px;"></footer>
      <div class="row">
        <div class="col-sm-7">
          <p class="fw-light">
            內文撰寫｜董冠霆<br>
            製&emsp;&emsp;圖｜董冠霆<br>
            網&emsp;&emsp;頁｜董冠霆<br>
            攝&emsp;&emsp;影｜董冠霆<br>
          </p>
          <p class="fw-light">
            聯絡方式：LineID @310956585<br>
            資料最後更新時間：<time datetime="2024-09-13T02:42">2024/09/13 02:42</time></p>
          <p class="fw-light">&copy; 2024 Copyright</p>
        </div>
        <div class="col-sm-5 d-flex justify-content-sm-end align-items-end">
          <a href="https://www.instagram.com/ting.d_927" class="d-inline-block me-3" target="_blank"><i class="bi bi-instagram"></i></a>
          <a href="https://www.facebook.com/guanting.dong" class="d-inline-block me-3" target="_blank"><i class="bi bi-facebook"></i></a>
          <a href="https://line.me/ti/p/fOtvr_KEbv" class="d-inline-block me-5" target="_blank"><i class="bi bi-line"></i></a>
        </div>
      </div>
    </footer>
  </body>
</html>