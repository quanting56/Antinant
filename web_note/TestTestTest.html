<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    <!-- Title -->
    <title>測試區</title>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="../css/bootstrap_5.3.3_css/bootstrap.min.css"/>
    <link rel="stylesheet" href="../css/bootstrap_icons-main/font/bootstrap-icons.css"/>
    <link rel="stylesheet" href="../css/font_awesome_v6.5.2_all.css" type="text/css" />
    <link rel="stylesheet" href="../css/animate_v4.1.1_min.css">
    <link rel="stylesheet" href="../css/vs2015_min.css">
    <link rel="stylesheet" href="../css/main.css"/>

    <!-- jQuery -->
    <script src="../js/jquery_v3.7.1_min.js"></script>
    <!-- Bootstrap Bundle JS -->
    <script src="../js/bootstrap_5.3.3_js/bootstrap.bundle.min.js"></script>
    <script src="../js/d3_v7.9.0_min.js"></script>
    <script src="../js/wow_v1.1.3_min.js"></script>
    <script src="../js/highlight_min.js"></script>
    <script src="../js/script.js"></script>

    <!-- // 啟用 Highlight.js -->
    <script>hljs.highlightAll();</script>

    <style>
      body {
        padding: 30px;
      }

      li {
        padding-top: 30px;
      }
    </style>
  </head>
  <body>
    <h2>歡迎來到測試場</h2>
    <hr>
    <ol>
      <li>
        散點圖
        <div id="basicScatter"></div>
        <script>
          const basicScatter = async() => {
            const svgWidth = 600;
            const svgHeight = 400;
            const margin = 50;
            const dotRadius = 1.5;
            const svg = d3.select("#basicScatter")
                          .append("svg")
                          .attr("width", svgWidth)
                          .attr("height", svgHeight);
            
            // 取資料
            const url = "https://raw.githubusercontent.com/holtzy/data_to_viz/master/Example_dataset/2_TwoNum.csv"
            const data = await d3.csv(`${url}`);

            // 建立X軸線
            const xScale = d3.scaleLinear()
                             .domain([0, 4000])
                             .range([margin, (svgWidth - margin)]);

            const xAxisGenerator = d3.axisBottom(xScale);

            svg.append("g")
               .attr("transform", `translate(0, ${svgHeight - margin})`)
               .call(xAxisGenerator);

            // 建立Y軸線
            const yScale = d3.scaleLinear()
                             .domain([0, 500000])
                             .range([(svgHeight - margin), margin]);
            
            const yAxisGenerator = d3.axisLeft(yScale)
                                     .tickFormat((d) => "$" + d);
            
            svg.append("g")
               .attr("transform", `translate(${margin}, 0)`)
               .call(yAxisGenerator);

            // 加上點點
            svg.append("g")
               .selectAll("circle")
               .data(data)
               .join("circle")
               .attr("cx", (d) => xScale(d.GrLivArea))
               .attr("cy", (d) => yScale(d.SalePrice))
               .attr("r", dotRadius)
               .style("fill", (d) => d.SalePrice > 129000 ? "pink" : "#69b3a2")
               .on("mouseover", handleMouseOver)
               .on("mouseout", handleMouseOut);
            
            // mouseover時點點變色+tooltip
            function handleMouseOver(e) {
              d3.select(this)  // 選定this元素，改變hover時的顏色和形狀
                .style("fill", "orange")
                .attr("r", dotRadius * 2)
                .style("cursor", "pointer");

              let pt = d3.pointer(e, e.target)
              svg.append("text")
                 .attr("class", "basicScatterHoverTextInfo")
                 .attr("x", pt[0] + 10)
                 .attr("y", pt[1] - 10)
                 .style("fill", "red")
                 .text([`GrLivArea: ${e.target.__data__.GrLivArea}, SalePrice: $${e.target.__data__.SalePrice}`]);
            };

            function handleMouseOut(e, d) {
              d3.selectAll(".basicScatterHoverTextInfo").remove();
              d3.select(this)
                .style("fill", (d) => d.SalePrice > 129000 ? "pink" : "#69b3a2")
                .attr("r", dotRadius);
            };
          };
          basicScatter();
        </script>
      </li>
      <li>
        可以透過點擊新增點點的散點圖
        <div id="addPointScatter"></div>
        <script>
          const addPointScatterWidth = 600;
          const addPointScatterHeight = 400;
          const addPointScatterMargin = 50;
          const addPointScatterDotRadius = 2;
          const addPointScatterData = [
            { x: 100,y: 110 }, { x: 83,y: 43 }, { x: 92,y: 28 },
            { x: 49,y: 74 }, { x: 51,y: 10 }, { x: 25,y: 98 },
            { x: 77,y: 30}, { x: 20,y: 83 }, { x: 11,y: 63 },
            { x: 4,y: 55 }, { x: 0,y: 0 }, { x: 85,y: 100 },
            { x: 60,y: 40 }, { x: 70,y: 80 }, { x: 10,y: 20 },
            { x: 40,y: 50 }, { x: 25,y: 31 }
          ]
          const addPointScatterSVG = d3.select("#addPointScatter")
                                       .append("svg")
                                       .attr("width", addPointScatterWidth)
                                       .attr("height", addPointScatterHeight);

          // 建立X軸線
          const addPointScatterXScale = d3.scaleLinear()
                                          .domain([0, (d3.max(addPointScatterData, d => d.x))])
                                          .range([addPointScatterMargin, addPointScatterWidth - addPointScatterMargin])
                                          .nice();
                           
          const addPointScatterXAxisGenerator = d3.axisBottom(addPointScatterXScale);

          addPointScatterSVG.append("g")
                            .attr("transform", `translate(0, ${addPointScatterHeight - addPointScatterMargin})`)
                            .call(addPointScatterXAxisGenerator);

          // 建立Y軸線
          const addPointScatterYScale = d3.scaleLinear()
                                          .domain([0, (d3.max(addPointScatterData, d => d.y))])
                                          .range([(addPointScatterHeight - addPointScatterMargin), addPointScatterMargin])
                                          .nice();

          const addPointScatterYAxisGenerator = d3.axisLeft(addPointScatterYScale);

          addPointScatterSVG.append("g")
                            .attr("transform", `translate(${addPointScatterMargin}, 0)`)
                            .call(addPointScatterYAxisGenerator);

          // 加上點點
          addPointScatterSVG.append("g")
                            .selectAll("circle")
                            .data(addPointScatterData)
                            .join("circle")
                            .attr("cx", (d) => addPointScatterXScale(d.x))
                            .attr("cy", (d) => addPointScatterYScale(d.y))
                            .attr("r", addPointScatterDotRadius)
                            .attr("fill", "#121212")
                            .on("mouseover", addPointScatterHandleMouseOver)
                            .on("mouseout", addPointScatterHandleMouseOut);
          
          // mouseover時點點變色+tooltip
          function addPointScatterHandleMouseOver(e) {
            d3.select(this)  // 選定this元素，改變hover時的顏色和形狀
              .style("fill", "orange")
              .attr("r", addPointScatterDotRadius * 2)
              .style("cursor", "pointer");
            
            let pt = d3.pointer(e, e.target)
            addPointScatterSVG.append("text")
                              .attr("class", "addPointScatterHoverTextInfo")
                              .attr("x", pt[0] + 10)
                              .attr("y", pt[1] - 10)
                              .style("fill", "red")
                              .text([`x:${e.target.__data__.x}, y:${e.target.__data__.y}`]);
          };

          function addPointScatterHandleMouseOut() {
            d3.selectAll(".addPointScatterHoverTextInfo").remove();
            d3.select(this)
              .style("fill", "#121212")
              .attr("r", addPointScatterDotRadius);
          };

          // 滑鼠click的時候增加一個點
          addPointScatterSVG.on("click", (e) => {
            const coords = d3.pointer(e, e.target);
            const newData = {
              x: Math.round(addPointScatterXScale.invert(coords[0])),
              y: Math.round(addPointScatterYScale.invert(coords[1]))
            };  // 透過scale.invert()把XY像素位置轉換回座標資料值

            // 將增加的資料座標推入原本的data
            addPointScatterData.push(newData);

            // 將新的資料綁定上circle
            addPointScatterSVG.selectAll("circle")
                              .data(addPointScatterData)
                              .join("circle")
                              .attr("cx", (d) => addPointScatterXScale(d.x))
                              .attr("cy", (d) => addPointScatterYScale(d.y))
                              .attr("r", addPointScatterDotRadius)
                              .attr("fill", "#121212")
                              .on("mouseover", addPointScatterHandleMouseOver)
                              .on("mouseout", addPointScatterHandleMouseOut);
          });
        </script>
      </li>
      <li>
        氣泡圖
        <div id="bubbleChart"></div>
        <script>
          const drawBubbleChart = async () => {
            // 設定圖表大小
            const svgWidth = 600;
            const svgHeight = 400;
            const margin = {top: 10, right: 20, bottom: 30, left: 50};
            const chartWidth = svgWidth - margin.left - margin.right;
            const chartHeight = svgHeight - margin.top - margin.bottom;

            // 建立svg
            const svg = d3.select("#bubbleChart")
                          .append("svg")
                          .attr("width", svgWidth)
                          .attr("height", svgHeight);

            // 匯入資料
            const url = "https://raw.githubusercontent.com/holtzy/data_to_viz/master/Example_dataset/4_ThreeNum.csv";
            const data = await d3.csv(`${url}`);

            // 整理X軸資料、Y軸資料、Z的人口數量資料
            const xData = data.map((d) => parseInt(d.gdpPercap));
            const yData = data.map((d) => d.lifeExp);
            const zData = data.map((d) => d.pop);

            // 建立X軸
            const xScale = d3.scaleLinear()
                             .domain([0, d3.max(xData)])
                             .range([margin.left, chartWidth])
                             .nice();
            const xAxisGenerator = d3.axisBottom(xScale);

            svg.append("g")
               .attr("transform", `translate(0, ${margin.top + chartHeight})`)
               .call(xAxisGenerator);

            // 建立Y軸
            const yScale = d3.scaleLinear()
                             .domain([0, d3.max(yData)])
                             .range([margin.top + chartHeight, margin.top])
                             .nice();
            const yAxisGenerator = d3.axisLeft(yScale);

            svg.append("g")
               .attr("transform", `translate(${margin.left}, 0)`)
               .call(yAxisGenerator);


            // 氣泡(Z)的部分
            // 按照人口去設定氣泡大小的比例尺
            const radiusScale = d3.scaleLinear()
                                  .domain([d3.min(zData), 1310000000])
                                  .range([4, 30]);

            // 設定氣泡顏色，本例根據不同洲來設定
            const bubbleColor = d3.scaleOrdinal()
                                  .domain(["Asia", "Europe", "Americas", "Africa", "Oceania"])
                                  .range(d3.schemeSet2);

            // 建立tooltip
            const tooltip = d3.select("#bubbleChart")
                              .style("position", "relative")
                              .append("div")
                              .style("display", "none")
                              .style("position", "absolute")
                              .attr("class", "dotsTooltip")
                              .style("background-color", "#121212")
                              .style("border-radius", "5px")
                              .style("padding", "10px")
                              .style("color", "#f2f2f2");

            // 設定顯示、移動、隱藏tooltips
            const showTooltip = (e, d) => {
              const pt = d3.pointer(e, e.target);

              // 設定tooltip樣式與呈現文字
              tooltip.style("display", "block")
                     .html(`<p>國家：${d.country}</p>
                            <p>所屬洲：${d.continent}</p>
                            <p>人口數：${d.pop}</p>
                            <p>平均壽命：${d.lifeExp}</p>
                            <p>人均GDP：${d.gdpPercap}</p>`)
                     .style("left", `${pt[0] + 10}px`)
                     .style("top", `${pt[1] + 10}px`);

              // 圓點強調
              d3.select(e.target)
                .attr("r", radiusScale(d.pop) + 5)
                .style("opacity", 0.7);
            };

            const moveTooltip = (e) => {
              const pt = d3.pointer(e, e.target);
              tooltip.style("display", "block")
                     .style("left", `${pt[0] + 10}px`)
                     .style("top", `${pt[1] + 10}px`);
            };

            const hideTooltip = (e, d) => {
              tooltip.style("display", "none");

              // 圓點復原
              d3.select(e.target)
                .attr("r", radiusScale(d.pop))
                .style("opacity", 1);
            };

            // 綁定氣泡
            const bubble = svg.append("g")
                              .selectAll("circle")
                              .data(data)
                              .join("circle")
                              .attr("cx", (d) => xScale(d.gdpPercap))
                              .attr("cy", (d) => yScale(d.lifeExp))
                              .attr("r", (d) => radiusScale(d.pop))
                              .style("fill", (d) => bubbleColor(d => d.continent))
                              .style("cursor", "pointer")
                              .on("mouseover", showTooltip)
                              .on("mousemove", moveTooltip)
                              .on("mouseleave", hideTooltip);
          };
          drawBubbleChart();
        </script>
      </li>
      <li>
        基礎長條圖
        <div id="barChart"></div>
        <div id="btnWrap">
          <button id="barChartApril2024Btn" class="btn btn-outline-warning" onclick="updateElectricChart('../data/taipowerData/202404.csv')">2024 4月</button>
          <button id="barChartMay2024Btn" class="btn btn-outline-warning" onclick="updateElectricChart('../data/taipowerData/202405.csv')">2024 5月</button>
          <button id="barChartJune2024Btn" class="btn btn-outline-warning" onclick="updateElectricChart('../data/taipowerData/202406.csv')">2024 6月</button>
        </div>
        <script>
          // 建立svg
          const barChartWidth = 750;
          const barChartHeight = 500;
          const barChartMargin = {top: 40, right: 40, bottom: 40, left: 80};
          const barChartSVG = d3.select("#barChart")
                                .append("svg")
                                .attr("width", barChartWidth)
                                .attr("height", barChartHeight);

          // 建立初始X軸
          const xScale = d3.scaleBand()
                           .range([barChartMargin.left, barChartWidth - barChartMargin.right])
                           .padding(0.2);
          const xAxisGenerator = d3.axisBottom(xScale);
          const xAxis = barChartSVG.append("g")
                                   .attr("transform", `translate(0, ${barChartHeight - barChartMargin.bottom})`);

          // 建立初始Y軸
          const yScale = d3.scaleLinear()
                           .range([barChartHeight - barChartMargin.bottom, barChartMargin.top]);
          const yAxisGenerator = d3.axisLeft(yScale)
                                   .ticks(5)
                                   .tickSize(3);
          const yAxis = barChartSVG.append("g")
                                   .attr("transform", `translate(${barChartMargin.left}, 0)`);

          // 取得資料
          const updateElectricChart = async (url) => {
            const data = await d3.csv(url);
            // map資料集
            xData = data.map((i) => i["縣市"]);
            yData = data.map((i) => parseInt(i["合計售電量_度"].split(",").join("")));

            // 設定X軸Domain、建立X軸
            xScale.domain(xData);
            xAxis.transition().duration(1000).call(xAxisGenerator);

            // 調整X軸刻度文字標籤傾斜
            xAxis.selectAll("text")
                 .attr("transform", "translate(-10, 0) rotate(-45)")
                 .style("text-anchor", "end");

            // 設定Y軸Domain、建立Y軸
            yScale.domain([0, d3.max(yData)]).nice();
            yAxis.transition().duration(1000).call(yAxisGenerator);

            // 開始建立長條圖
            const bar = barChartSVG.selectAll("rect")
                                   .data(data)
                                   .join("rect");

            // 加上漸增動畫
            // 注意：如果要加動畫，事件要分開寫
            bar.transition()
               .duration(1000)
               .attr("x", d => xScale(d["縣市"]))
               .attr("y", d => yScale(parseInt(d["合計售電量_度"].split(",").join(""))))
               .attr("width", xScale.bandwidth())
               .attr("height", d => ( barChartHeight - barChartMargin ) - yScale(parseInt(d["合計售電量_度"].split(",").join(""))) )
               .attr("fill", "#69b3a2");

            // 加上滑鼠事件（未完成，目前y軸長條圖還出不來）
          };
          updateElectricChart('../data/taipowerData/202404.csv');
        </script>
      </li>
    </ol>
  </body>
</html>